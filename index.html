<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SAT Prep</title>
  <style>
    :root {
      --primary-color: #4a6ee0;
      --secondary-color: #f0f4f8;
      --text-color: #333;
      --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font-family);
      background-color: var(--secondary-color);
      color: var(--text-color);
      line-height: 1.6;
      font-size: 16px;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    header {
      background-color: white;
      padding: 1rem 0;
      margin-bottom: 2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    .logo {
      color: var(--primary-color);
      font-size: 1.5rem;
      font-weight: bold;
    }
    .user-info {
      display: flex;
      align-items: center;
    }
    .user-info img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-left: 10px;
    }
    .user-info button {
      margin-left: 10px;
      padding: 5px 10px;
      font-size: 0.9rem;
      border: none;
      border-radius: 5px;
      background-color: var(--primary-color);
      color: white;
      cursor: pointer;
    }
    h1 { font-size: 2rem; color: var(--primary-color); margin-bottom: 1rem; }
    .card {
      background-color: white;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .tab-container {
      display: flex;
      background-color: #e0e0e0;
      border-radius: 20px;
      overflow: hidden;
    }
    .tab {
      padding: 0.5rem 1rem;
      cursor: pointer;
    }
    .tab.active {
      background-color: var(--primary-color);
      color: white;
    }
    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 12px 20px;
      margin: 10px 0;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 20px;
      transition: background-color 0.3s ease;
      width: 100%;
    }
    button:hover { background-color: #3558b2; }
    .practice-item {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
    }
    .practice-item .icon {
      font-size: 2rem;
      margin-right: 1rem;
      width: 50px;
      height: 50px;
      min-width: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: var(--secondary-color);
      border-radius: 25px;
    }
    #practiceView { display: none; }
    #questionLabel {
      font-size: 1.1rem;
      margin-bottom: 1rem;
    }
    #optionButtons button {
      background-color: white;
      color: var(--text-color);
      border: 1px solid #e0e0e0;
      margin: 0.5rem 0;
      text-align: left;
      width: 100%;
      transition: background-color 0.3s ease;
    }
    #optionButtons button:hover {
      background-color: var(--secondary-color);
    }
    #feedbackLabel {
      margin-top: 1rem;
      font-weight: bold;
      text-align: center;
    }
    .progress-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .progress-bar {
      flex-grow: 1;
      height: 8px;
      background-color: #e0e0e0;
      border-radius: 4px;
      margin: 0 1rem;
      overflow: hidden;
      min-width: 100px;
    }
    .progress {
      height: 100%;
      background-color: var(--primary-color);
      width: 0%;
      transition: width 0.5s ease;
    }
    .passage-container {
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      font-size: 0.9rem;
      line-height: 1.6;
    }
    .question-number {
      font-weight: bold;
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
    }
    /* =========================================================================
       Revamped Settings Modal
    ========================================================================= */
    #settingsMenu {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    #settingsMenu.active {
      opacity: 1;
      pointer-events: auto;
    }
    #settingsContent {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      position: relative;
      animation: slideDown 0.5s ease forwards;
    }
    @keyframes slideDown {
      from { transform: translateY(-30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .settings-header h2 {
      font-size: 1.5rem;
      color: #4a6ee0;
    }
    .close-btn {
      background: transparent;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #333;
    }
    .settings-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .settings-body button {
      background: #4a6ee0;
      border: none;
      color: #fff;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .settings-body button:hover {
      background: #3558b2;
    }
    .settings-output {
      margin-top: 20px;
      padding: 10px;
      background: #f0f4f8;
      border-radius: 5px;
      font-size: 0.9rem;
      color: #333;
      max-height: 200px;
      overflow-y: auto;
    }
    /* =========================================================================
       Calculator Styles (Unchanged)
    ========================================================================= */
    #dosCalculator {
      position: fixed;
      top: 50px;
      right: 20px;
      background-color: #f8f9fa;
      color: #333;
      padding: 20px;
      border: 2px solid #4a6ee0;
      border-radius: 12px;
      font-family: 'Courier New', monospace;
      display: none;
      z-index: 1000;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    #calculatorDisplay {
      background-color: #222;
      padding: 15px;
      margin-bottom: 20px;
      text-align: right;
      color: #0f0;
      font-size: 1.5rem;
      border-radius: 8px;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
      height: 50px;
      display: flex;
      align-items: center;
    }
    #dosCalculator button {
      width: 60px;
      height: 60px;
      margin: 5px;
      background-color: #4a6ee0;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1.2rem;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.1s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    #dosCalculator button:hover {
      background-color: #3558b2;
      transform: scale(1.05);
    }
    #dosCalculator button:active {
      transform: scale(0.95);
    }
    /* =========================================================================
       Admin Panel (Unchanged)
    ========================================================================= */
    #adminArea {
      display: none;
      margin-top: 20px;
    }
    #adminArea h2 {
      margin-bottom: 1rem;
    }
    #adminContent div {
      border-bottom: 1px solid #ccc;
      padding: 10px 0;
    }
  </style>
  <!-- Firebase SDKs (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD9j0rXC-5rTjJOPgYYFDpi_nc9hevLDLg",
      authDomain: "sat-practice-de760.firebaseapp.com",
      databaseURL: "https://sat-practice-de760-default-rtdb.firebaseio.com",
      projectId: "sat-practice-de760",
      appId: "1:324343144842:web:83ec350e3e72b5b9466873"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
  </script>
  <!-- External Files -->
  <script src="math-questions.js"></script>
  <script src="verbal-questions.js"></script>
  <script src="writing-questions.js"></script>
  <script src="popup.js"></script>
  <script src="dos-calculator.js"></script>
  <script src="storage.js"></script>
</head>
<body>
  <header class="container">
    <div class="logo">SAT Prep</div>
    <div class="user-info">
      <span id="userName">Guest</span>
      <img id="userAvatar" src="https://via.placeholder.com/40" alt="User Avatar">
      <button id="signInBtn">Sign In with Google</button>
      <button id="signOutBtn" style="display:none;">Sign Out</button>
      <button id="openSettings">Settings</button>
    </div>
  </header>

  <main class="container" id="mainContent">
    <section id="mainMenu">
      <h1>Welcome! Good luck on test day!</h1>
      <div class="card">
        <div class="section-header">
          <h2>Your Tests</h2>
          <div class="tab-container">
            <div class="tab active" id="activeTab">Active</div>
            <div class="tab" id="pastTab">Past</div>
          </div>
        </div>
        <p>You may have an upcoming test assigned to you.</p>
      </div>
      <!-- Container for displaying tests -->
      <div id="testsList"></div>
      <div class="card">
        <div class="section-header">
          <h2>Practice and Prepare</h2>
          <div class="tab-container">
            <div class="tab active">Active</div>
            <div class="tab">Past</div>
          </div>
        </div>
        <div class="practice-item">
          <span class="icon">📐</span>
          <button class="start-practice" data-type="Math">Math Practice</button>
        </div>
        <div class="practice-item">
          <span class="icon">📚</span>
          <button class="start-practice" data-type="Verbal">Verbal Practice</button>
        </div>
        <div class="practice-item">
          <span class="icon">✍️</span>
          <button class="start-practice" data-type="Writing">Writing Practice</button>
        </div>
      </div>
    </section>

    <section id="practiceView" class="card">
      <button id="backButton">Back to Menu</button>
      <h2 id="practiceTitle"></h2>
      <div class="progress-container">
        <span id="questionNumber"></span>
        <div class="progress-bar">
          <div id="progressBar" class="progress"></div>
        </div>
        <span id="timeRemaining">10:00</span>
      </div>
      <p id="questionLabel"></p>
      <div id="optionButtons"></div>
      <p id="feedbackLabel"></p>
      <button id="nextButton">Next Question</button>
      <button id="toggleCalculator">Toggle Calculator</button>
    </section>

    <!-- Admin Panel Section (Hidden by default) -->
    <section id="adminArea" class="card">
      <h2>Admin Panel</h2>
      <button id="refreshAdminData">Refresh Data</button>
      <div id="adminContent"></div>
    </section>
  </main>

  <!-- Revamped Settings Modal -->
  <div id="settingsMenu">
    <div id="settingsContent">
      <div class="settings-header">
        <h2>Settings</h2>
        <button id="btnCloseSettings" class="close-btn">&times;</button>
      </div>
      <div class="settings-body">
        <button id="btnViewSession">View Saved Practice Session</button>
        <button id="btnClearSession">Clear Saved Practice Session</button>
        <button id="btnViewTests">View Completed Tests</button>
        <button id="btnClearTests">Clear Completed Tests</button>
        <button id="btnAdminLogin">Admin Login</button>
      </div>
      <div id="settingsOutput" class="settings-output"></div>
    </div>
  </div>

  <!-- Calculator -->
  <div id="dosCalculator">
    <div id="calculatorDisplay">0</div>
    <div>
      <button data-action="clear">C</button>
      <button data-digit="7">7</button>
      <button data-digit="8">8</button>
      <button data-digit="9">9</button>
      <button data-operator="/">/</button>
    </div>
    <div>
      <button data-digit="4">4</button>
      <button data-digit="5">5</button>
      <button data-digit="6">6</button>
      <button data-operator="*">X</button>
    </div>
    <div>
      <button data-digit="1">1</button>
      <button data-digit="2">2</button>
      <button data-digit="3">3</button>
      <button data-operator="-">-</button>
    </div>
    <div>
      <button data-digit="0">0</button>
      <button data-action="decimal">.</button>
      <button data-operator="=">=</button>
      <button data-operator="+">+</button>
    </div>
  </div>

  <!-- =========================================================================
       JavaScript Section
       (Navigation, Auth, Practice Test Logic, Tests Tabs, Test-Taking, Admin Test Creation, Settings)
  ========================================================================= -->
  <script>
    /* ----------------------------
       Navigation & Page Switching
    ----------------------------- */
    function navigateTo(pageId) {
      document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
    }
    document.getElementById('navHome').onclick = (e) => { e.preventDefault(); navigateTo('homePage'); };
    document.getElementById('navPractice').onclick = (e) => { e.preventDefault(); navigateTo('practicePage'); };
    document.getElementById('navTests').onclick = (e) => {
      e.preventDefault();
      navigateTo('testsPage');
      setActiveTab(activeTab);
      loadUpcomingTests();
    };
    document.getElementById('navSettings').onclick = (e) => {
      e.preventDefault();
      document.getElementById('settingsMenu').classList.add('active');
    };
    document.getElementById('navCreate').onclick = (e) => {
      e.preventDefault();
      if (window.isAdmin) { navigateTo('createTestPage'); }
      else { alert("Admin privileges required to create tests."); }
    };
  
    /* ----------------------------
       Firebase Auth Setup
    ----------------------------- */
    const provider = new firebase.auth.GoogleAuthProvider();
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const userNameEl = document.getElementById('userName');
    const userAvatarEl = document.getElementById('userAvatar');
    signInBtn.onclick = () => { auth.signInWithPopup(provider).catch(err => console.error('SignIn failed:', err)); };
    signOutBtn.onclick = () => { auth.signOut().catch(err => console.error('SignOut failed:', err)); };
    auth.onAuthStateChanged(user => {
      if (user) {
        userNameEl.textContent = user.displayName || 'User';
        userAvatarEl.src = user.photoURL || 'https://via.placeholder.com/40';
        signInBtn.style.display = 'none';
        signOutBtn.style.display = 'inline-block';
        db.ref('users/' + user.uid + '/profile').set({ name: user.displayName, email: user.email });
      } else {
        userNameEl.textContent = 'Guest';
        userAvatarEl.src = 'https://via.placeholder.com/40';
        signInBtn.style.display = 'inline-block';
        signOutBtn.style.display = 'none';
        document.getElementById('adminArea').style.display = 'none';
      }
    });
  
    /* ----------------------------
       MAIN PRACTICE TEST LOGIC
    ----------------------------- */
    let currentPractice, currentQuestions, timerInterval;
    let currentQuestionIndex = 0, correctAnswers = 0, timeRemaining = 600;
    const totalQuestions = 5;
    document.querySelectorAll('.start-practice').forEach(btn => { btn.addEventListener('click', () => startPractice(btn.dataset.type)); });
    document.getElementById('backButton').addEventListener('click', showMainMenu);
    document.getElementById('nextButton').addEventListener('click', showQuestion);
    document.getElementById('toggleCalculator').addEventListener('click', toggleCalculator);
  
    function startPractice(type) {
      currentPractice = type;
      mainMenu.style.display = 'none';
      practiceView.style.display = 'block';
      practiceTitle.textContent = `${type} Practice`;
      currentQuestions = shuffleArray(getQuestionsByType(type)).slice(0, totalQuestions);
      currentQuestionIndex = correctAnswers = 0;
      timeRemaining = 600;
      updateProgressBar();
      startTimer();
      showQuestion();
      toggleCalculatorBtn.style.display = type === 'Math' ? 'block' : 'none';
    }
  
    function getQuestionsByType(type) {
      return { Math: mathQuestions, Verbal: verbalQuestions, Writing: writingQuestions }[type] || [];
    }
  
    function shuffleArray(array) { return array.sort(() => Math.random() - 0.5); }
  
    function showQuestion() {
      if (currentQuestionIndex >= totalQuestions) { finishPractice(); return; }
      const question = currentQuestions[currentQuestionIndex];
      questionLabel.textContent = question.text;
      optionButtons.innerHTML = '';
      feedbackLabel.textContent = '';
      nextButton.style.display = 'none';
      document.querySelectorAll('.passage-container, .question-number').forEach(el => el.remove());
      if (question.hasPassage) {
        const passageEl = document.createElement('div');
        passageEl.className = 'passage-container';
        passageEl.textContent = question.passage;
        practiceView.insertBefore(passageEl, questionLabel);
      }
      const questionNumberEl = document.createElement('div');
      questionNumberEl.className = 'question-number';
      questionNumberEl.textContent = `Question ${currentQuestionIndex + 1} of ${totalQuestions}`;
      practiceView.insertBefore(questionNumberEl, questionLabel);
      question.options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.textContent = `${String.fromCharCode(65 + idx)}. ${opt}`;
        btn.addEventListener('click', () => checkAnswer(opt));
        optionButtons.appendChild(btn);
      });
      updateProgressBar();
    }
  
    function checkAnswer(answer) {
      const question = currentQuestions[currentQuestionIndex];
      const isCorrect = answer === question.correctAnswer;
      feedbackLabel.textContent = isCorrect ? "Correct!" : `Incorrect. The correct answer is: ${question.correctAnswer}`;
      feedbackLabel.style.color = isCorrect ? '#4CAF50' : '#F44336';
      if (isCorrect) correctAnswers++;
      currentQuestionIndex++;
      nextButton.style.display = 'block';
      document.querySelectorAll('#optionButtons button').forEach(btn => btn.disabled = true);
      updateProgressBar();
    }
  
    function updateProgressBar() {
      progressBar.style.width = `${(currentQuestionIndex / totalQuestions) * 100}%`;
    }
  
    function startTimer() {
      clearInterval(timerInterval);
      updateTimerDisplay();
      timerInterval = setInterval(() => {
        if (timeRemaining > 0) { timeRemaining--; updateTimerDisplay(); }
        else { clearInterval(timerInterval); finishPractice(); }
      }, 1000);
    }
  
    function updateTimerDisplay() {
      const minutes = Math.floor(timeRemaining / 60);
      const seconds = timeRemaining % 60;
      timeDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
  
    function finishPractice() {
      clearInterval(timerInterval);
      const scorePercentage = ((correctAnswers / totalQuestions) * 100).toFixed(1);
      const questionIDs = currentQuestions.map(q => q.id);
      const user = auth.currentUser;
      if (user) {
        const testData = {
          type: currentPractice,
          score: scorePercentage,
          correctAnswers,
          totalQuestions,
          date: new Date().toISOString(),
          questionIDs: questionIDs
        };
        window.satPracticeStorage.saveCompletedTest(testData);
        alert(`Practice complete! Your score: ${scorePercentage}%. Test saved to your account.`);
      } else {
        alert(`Practice complete! Your score: ${scorePercentage}%. (Sign in to save your results)`);
      }
      showMainMenu();
    }
  
    function showMainMenu() {
      mainMenu.style.display = 'block';
      practiceView.style.display = 'none';
      currentQuestionIndex = correctAnswers = 0;
      timeRemaining = 600;
      progressBar.style.width = '0%';
      feedbackLabel.textContent = '';
      timeDisplay.textContent = '10:00';
      questionLabel.textContent = '';
      optionButtons.innerHTML = '';
      nextButton.style.display = 'none';
      document.getElementById('dosCalculator').style.display = 'none';
    }
  
    function toggleCalculator() {
      const calculator = document.getElementById('dosCalculator');
      calculator.style.display = calculator.style.display === 'none' ? 'block' : 'none';
    }
  
    /* ----------------------------
       TEST TABS FUNCTIONALITY
    ----------------------------- */
    const activeTab = document.getElementById('activeTab');
    const pastTab = document.getElementById('pastTab');
    activeTab.onclick = () => { setActiveTab(activeTab); loadUpcomingTests(); };
    pastTab.onclick = () => { setActiveTab(pastTab); loadPastTests(); };
    function setActiveTab(tab) {
      activeTab.classList.remove('active');
      pastTab.classList.remove('active');
      tab.classList.add('active');
    }
  
    function loadUpcomingTests() {
      const testsList = document.getElementById('testsList');
      testsList.innerHTML = "Loading upcoming tests...";
      if (window.satPracticeStorage.getAssignedTests) {
        window.satPracticeStorage.getAssignedTests(tests => {
          if (tests.length > 0) {
            let html = "<h3>Upcoming Tests</h3><ul>";
            tests.forEach(test => {
              html += `<li>${test.type} Test scheduled for ${new Date(test.date).toLocaleString()}`;
              if (test.questionIDs) {
                html += `<br><small>Questions: ${test.questionIDs.join(', ')}</small>`;
              }
              html += "</li>";
            });
            html += "</ul>";
            testsList.innerHTML = html;
          } else { testsList.innerHTML = "No upcoming tests found."; }
        });
      } else { testsList.innerHTML = "Upcoming tests functionality is not available."; }
    }
  
    function loadPastTests() {
      const testsList = document.getElementById('testsList');
      testsList.innerHTML = "Loading past tests...";
      window.satPracticeStorage.getCompletedTests(tests => {
        if (tests.length > 0) {
          let html = "<h3>Past Tests</h3><ul>";
          tests.forEach(test => {
            html += `<li>${test.type} Test on ${new Date(test.date).toLocaleString()} - Score: ${test.score}%`;
            if (test.questionIDs) { html += `<br><small>Questions: ${test.questionIDs.join(', ')}</small>`; }
            html += "</li>";
          });
          html += "</ul>";
          testsList.innerHTML = html;
        } else { testsList.innerHTML = "No past tests found."; }
      });
    }
  
    /* ----------------------------
       TEST-TAKING FROM ASSIGNED TEST
    ----------------------------- */
    function takeTest(testData) {
      let bank;
      const type = testData.type.toLowerCase();
      if (type === "math") bank = mathQuestions;
      else if (type === "verbal") bank = verbalQuestions;
      else if (type === "writing") bank = writingQuestions;
      else { alert("Unknown test type."); return; }
      const ids = testData.questionIDs.map(id => parseInt(id, 10));
      currentQuestions = bank.filter(q => ids.includes(q.id));
      if (currentQuestions.length === 0) { alert("No matching questions found for this test."); return; }
      currentPractice = testData.type;
      currentQuestionIndex = 0;
      correctAnswers = 0;
      timeRemaining = 600;
      navigateTo("practicePage");
      document.getElementById("practiceTitle").textContent = `${testData.type} Test`;
      updateProgressBar();
      startTimer();
      showQuestion();
    }
  
    /* ----------------------------
       ADMIN TEST CREATION PAGE
    ----------------------------- */
    document.getElementById('navCreate').onclick = (e) => {
      e.preventDefault();
      if (window.isAdmin) { navigateTo('createTestPage'); }
      else { alert("Admin privileges required to create tests."); }
    };
    document.getElementById('backToHomeFromCreate').onclick = () => { navigateTo('homePage'); };
    document.getElementById('testForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const type = document.getElementById('testType').value;
      const date = document.getElementById('testDate').value;
      const questionIDsStr = document.getElementById('questionIDs').value;
      const questionIDs = questionIDsStr.split(',').map(id => id.trim());
      if (!type || !date || questionIDs.length === 0) {
        document.getElementById('createTestOutput').innerText = "Please complete all fields.";
        return;
      }
      const user = auth.currentUser;
      if (!user) { alert("You must be signed in to create a test."); return; }
      const testData = { type: type, date: date, questionIDs: questionIDs };
      db.ref(`assignedTests/${user.uid}`).push(testData)
        .then(() => {
          document.getElementById('createTestOutput').innerText = "Test created successfully.";
          document.getElementById('testForm').reset();
        })
        .catch(err => {
          document.getElementById('createTestOutput').innerText = "Error creating test: " + err.message;
        });
    });
  
    /* ----------------------------
       SETTINGS MODAL
    ----------------------------- */
    const settingsMenu = document.getElementById('settingsMenu');
    const settingsOutput = document.getElementById('settingsOutput');
    document.getElementById('btnCloseSettings').onclick = () => { settingsMenu.classList.remove('active'); };
    document.getElementById('btnViewSession').onclick = () => {
      window.satPracticeStorage.loadPracticeSession(session => {
        settingsOutput.innerText = session ? JSON.stringify(session, null, 2) : 'No saved practice session found.';
      });
    };
    document.getElementById('btnClearSession').onclick = () => {
      window.satPracticeStorage.clearPracticeSession();
      settingsOutput.innerText = 'Practice session cleared.';
    };
    document.getElementById('btnViewTests').onclick = () => {
      window.satPracticeStorage.getCompletedTests(tests => {
        settingsOutput.innerText = tests.length ? JSON.stringify(tests, null, 2) : 'No completed tests found.';
      });
    };
    document.getElementById('btnClearTests').onclick = () => {
      const user = auth.currentUser;
      if (!user) {
        settingsOutput.innerText = 'Not signed in. No tests to clear.';
        return;
      }
      firebase.database().ref(`users/${user.uid}/completedTests`).remove()
        .then(() => { settingsOutput.innerText = 'Completed tests cleared.'; });
    };
  
    /* ----------------------------
       ADMIN FUNCTIONALITY
    ----------------------------- */
    document.getElementById('btnAdminLogin').onclick = () => {
      if (!auth.currentUser) {
        alert("You must be signed in to become an admin.");
        return;
      }
      const code = prompt("Enter the 4-digit admin code:");
      if (code === "1234") {  // Change as needed
        window.isAdmin = true;
        alert("Admin privileges granted.");
        document.getElementById('adminArea').style.display = 'block';
        fetchAdminData();
      } else { alert("Incorrect code."); }
    };
    document.getElementById('refreshAdminData').onclick = fetchAdminData;
    function fetchAdminData() {
      firebase.database().ref('users').once('value')
        .then(snapshot => {
          const data = snapshot.val();
          let html = '';
          if (data) {
            for (const uid in data) {
              const profile = data[uid].profile;
              const name = (profile && profile.name) ? profile.name : 'Unknown';
              html += `<div><strong>User:</strong> ${name} (${uid})<br>`;
              if (data[uid].completedTests) {
                html += `<ul>`;
                for (const testKey in data[uid].completedTests) {
                  const test = data[uid].completedTests[testKey];
                  html += `<li>${test.type} Test on ${new Date(test.date).toLocaleString()} - Score: ${test.score}%<br>
                           <small>Questions: ${test.questionIDs.join(', ')}</small></li>`;
                }
                html += `</ul>`;
              } else { html += `<p>No completed tests.</p>`; }
              html += `</div>`;
            }
          } else { html = '<p>No user data found.</p>'; }
          document.getElementById('adminContent').innerHTML = html;
        })
        .catch(err => { console.error("Error fetching admin data:", err); });
  
    /* ----------------------------
       On Load: Default to Home Page / Upcoming Tests
    ----------------------------- */
    window.addEventListener('load', () => {
      navigateTo('homePage');
      setActiveTab(activeTab);
      loadUpcomingTests();
    });
  </script>
</body>
</html>
