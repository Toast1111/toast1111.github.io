<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SAT Prep - Modern Overhaul</title>
  <style>
    /* =========================================================================
       Global Resets and Base Styles
    ========================================================================= */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f6f8;
      color: #333;
      line-height: 1.6;
      overflow-x: hidden;
    }
    a { text-decoration: none; color: inherit; }
    
    /* =========================================================================
       Navigation Bar & Header
    ========================================================================= */
    header {
      background: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 10px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: background 0.3s ease;
    }
    header:hover { background: #f9fafb; }
    .logo {
      font-size: 1.8rem;
      font-weight: bold;
      color: #4a6ee0;
    }
    nav {
      display: flex;
      gap: 20px;
    }
    nav a {
      font-size: 1rem;
      padding: 5px 10px;
      color: #333;
      border-radius: 4px;
      transition: background 0.3s ease, color 0.3s ease;
    }
    nav a:hover { background: #4a6ee0; color: #fff; }
    
    /* User Info */
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .user-info img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }
    .user-info button {
      background: #4a6ee0;
      border: none;
      color: #fff;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s ease;
    }
    .user-info button:hover { background: #3558b2; }
    
    /* =========================================================================
       Page Sections & Transitions
    ========================================================================= */
    .page {
      display: none;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.5s ease, transform 0.5s ease;
      padding: 20px;
      min-height: calc(100vh - 70px);
    }
    .page.active {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }
    
    /* =========================================================================
       Card Components
    ========================================================================= */
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      animation: fadeInUp 0.6s ease;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* =========================================================================
       General Button Styles
    ========================================================================= */
    button {
      background: #4a6ee0;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.3s ease;
    }
    button:hover { background: #3558b2; }
    
    /* =========================================================================
       Practice Test Styles
    ========================================================================= */
    #practiceView button { margin-top: 10px; }
    .progress-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 15px 0;
    }
    .progress-bar {
      flex-grow: 1;
      height: 8px;
      background: #ddd;
      border-radius: 4px;
      overflow: hidden;
    }
    .progress {
      height: 100%;
      width: 0%;
      background: #4a6ee0;
      transition: width 0.5s ease;
    }
    .passage-container {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      font-size: 0.9rem;
    }
    .question-number {
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 1.1rem;
    }
    #optionButtons button {
      background: #fff;
      color: #333;
      border: 1px solid #e0e0e0;
      margin: 5px 0;
      text-align: left;
      width: 100%;
      padding: 10px;
      transition: background 0.3s ease;
    }
    #optionButtons button:hover { background: #f0f4f8; }
    
    /* =========================================================================
       Tests Page Tabs
    ========================================================================= */
    .tab-container {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .tab {
      flex: 1;
      text-align: center;
      padding: 10px;
      border-radius: 25px;
      background: #ddd;
      cursor: pointer;
      transition: background 0.3s;
    }
    .tab.active {
      background: #4a6ee0;
      color: #fff;
    }
    #testsList ul { list-style: none; padding-left: 0; }
    #testsList li { padding: 10px; border-bottom: 1px solid #eee; }
    #testsList li small { color: #777; }
    
    /* =========================================================================
       Create Test Page (For Admin)
    ========================================================================= */
    #createTestPage {
      display: none;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.5s ease, transform 0.5s ease;
      padding: 20px;
      min-height: calc(100vh - 70px);
    }
    #createTestPage.active {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }
    #testForm label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    #testForm input, #testForm textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #testForm button { margin-top: 15px; }
    
    /* =========================================================================
       Settings Modal Styles
    ========================================================================= */
    #settingsMenu {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    #settingsContent {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
    }
    #settingsContent h2 { margin-bottom: 10px; }
    #settingsContent button { margin: 5px 0; width: 100%; }
    #settingsOutput {
      margin-top: 10px;
      background: #f0f4f8;
      padding: 10px;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    
    /* =========================================================================
       Calculator (Floating) Styles
    ========================================================================= */
    #dosCalculator {
      position: fixed;
      top: 70px;
      right: 20px;
      background: #fff;
      padding: 15px;
      border: 2px solid #4a6ee0;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      display: none;
      z-index: 3000;
    }
    #calculatorDisplay {
      background: #222;
      color: #0f0;
      padding: 10px;
      margin-bottom: 10px;
      text-align: right;
      border-radius: 4px;
      font-size: 1.2rem;
    }
    
    /* =========================================================================
       Additional Animations & Utilities
    ========================================================================= */
    .fade-in { animation: fadeIn 0.5s ease forwards; }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .slide-up { animation: slideUp 0.5s ease forwards; }
    @keyframes slideUp {
      from { transform: translateY(20px); }
      to { transform: translateY(0); }
    }
  </style>
  <!-- =========================================================================
       Firebase SDKs (Compat)
  ========================================================================= -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD9j0rXC-5rTjJOPgYYFDpi_nc9hevLDLg",
      authDomain: "sat-practice-de760.firebaseapp.com",
      databaseURL: "https://sat-practice-de760-default-rtdb.firebaseio.com",
      projectId: "sat-practice-de760",
      appId: "1:324343144842:web:83ec350e3e72b5b9466873"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
  </script>
  <!-- =========================================================================
       External Files
       (math-questions.js, verbal-questions.js, writing-questions.js, popup.js, dos-calculator.js, storage.js)
  ========================================================================= -->
  <script src="math-questions.js"></script>
  <script src="verbal-questions.js"></script>
  <script src="writing-questions.js"></script>
  <script src="popup.js"></script>
  <script src="dos-calculator.js"></script>
  <script src="storage.js"></script>
</head>
<body>
  <!-- Navigation Bar -->
  <header>
    <div class="logo">SAT Prep</div>
    <nav>
      <a href="#" id="navHome">Home</a>
      <a href="#" id="navPractice">Practice</a>
      <a href="#" id="navTests">Tests</a>
      <a href="#" id="navCreate">Create Test</a>
      <a href="#" id="navSettings">Settings</a>
    </nav>
    <div class="user-info">
      <span id="userName">Guest</span>
      <img id="userAvatar" src="https://via.placeholder.com/40" alt="User Avatar">
      <button id="signInBtn">Sign In with Google</button>
      <button id="signOutBtn" style="display:none;">Sign Out</button>
    </div>
  </header>

  <!-- =========================================================================
       Page Sections
  ========================================================================= -->
  <section id="homePage" class="page active">
    <div class="card fade-in">
      <h1>Welcome to SAT Prep!</h1>
      <p>Your journey to test success starts here. Use the navigation above to practice, view tests, or create a custom test (admin only).</p>
    </div>
  </section>

  <section id="practicePage" class="page">
    <div class="card" id="practiceView">
      <button id="backToHomeFromPractice">← Back to Home</button>
      <h2 id="practiceTitle"></h2>
      <div class="progress-container">
        <span id="questionNumber"></span>
        <div class="progress-bar">
          <div id="progressBar" class="progress"></div>
        </div>
        <span id="timeRemaining">10:00</span>
      </div>
      <p id="questionLabel"></p>
      <div id="optionButtons"></div>
      <p id="feedbackLabel"></p>
      <button id="nextButton">Next Question</button>
      <button id="toggleCalculator">Toggle Calculator</button>
    </div>
  </section>

  <section id="testsPage" class="page">
    <div class="card">
      <h2>Your Tests</h2>
      <div class="tab-container">
        <div class="tab active" id="activeTab">Upcoming</div>
        <div class="tab" id="pastTab">Past</div>
      </div>
      <div id="testsList"></div>
    </div>
    <!-- Admin Panel (Optional) -->
    <div id="adminArea" class="card" style="display:none;">
      <h2>Admin Panel</h2>
      <button id="refreshAdminData">Refresh Data</button>
      <div id="adminContent"></div>
    </div>
  </section>

  <section id="createTestPage" class="page">
    <div class="card">
      <button id="backToHomeFromCreate">← Back to Home</button>
      <h2>Create Custom Test</h2>
      <form id="testForm">
        <label for="testType">Test Type</label>
        <input type="text" id="testType" placeholder="Math, Verbal, Writing" required>
        <label for="testDate">Scheduled Date/Time</label>
        <input type="datetime-local" id="testDate" required>
        <label for="questionIDs">Question IDs (comma separated)</label>
        <textarea id="questionIDs" rows="3" placeholder="e.g., 101,102,103" required></textarea>
        <button type="submit">Create Test</button>
      </form>
      <div id="createTestOutput"></div>
    </div>
  </section>

  <!-- Settings Modal -->
  <div id="settingsMenu">
    <div id="settingsContent">
      <h2>Settings</h2>
      <button id="btnViewSession">View Saved Practice Session</button>
      <button id="btnClearSession">Clear Saved Practice Session</button>
      <button id="btnViewTests">View Completed Tests</button>
      <button id="btnClearTests">Clear Completed Tests</button>
      <button id="btnAdminLogin">Admin Login</button>
      <button id="btnCloseSettings">Close</button>
      <div id="settingsOutput"></div>
    </div>
  </div>

  <!-- Calculator -->
  <div id="dosCalculator">
    <div id="calculatorDisplay">0</div>
    <div>
      <button data-action="clear">C</button>
      <button data-digit="7">7</button>
      <button data-digit="8">8</button>
      <button data-digit="9">9</button>
      <button data-operator="/">/</button>
    </div>
    <div>
      <button data-digit="4">4</button>
      <button data-digit="5">5</button>
      <button data-digit="6">6</button>
      <button data-operator="*">X</button>
    </div>
    <div>
      <button data-digit="1">1</button>
      <button data-digit="2">2</button>
      <button data-digit="3">3</button>
      <button data-operator="-">-</button>
    </div>
    <div>
      <button data-digit="0">0</button>
      <button data-action="decimal">.</button>
      <button data-operator="=">=</button>
      <button data-operator="+">+</button>
    </div>
  </div>

  <!-- =========================================================================
       JavaScript Section
       (Navigation, Auth, Practice Test Logic, Tests Tabs, Test-Taking, Admin Test Creation, Settings)
  ========================================================================= -->
  <script>
    /* ----------------------------
       Navigation & Page Switching
    ----------------------------- */
    function navigateTo(pageId) {
      document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
    }
    document.getElementById('navHome').onclick = (e) => { e.preventDefault(); navigateTo('homePage'); };
    document.getElementById('navPractice').onclick = (e) => { e.preventDefault(); navigateTo('practicePage'); };
    document.getElementById('navTests').onclick = (e) => {
      e.preventDefault();
      navigateTo('testsPage');
      setActiveTab(activeTab);
      loadUpcomingTests();
    };
    document.getElementById('navSettings').onclick = (e) => {
      e.preventDefault();
      document.getElementById('settingsMenu').style.display = 'flex';
    };
    document.getElementById('navCreate').onclick = (e) => {
      e.preventDefault();
      if (window.isAdmin) { navigateTo('createTestPage'); }
      else { alert("Admin privileges required to create tests."); }
    };

    /* ----------------------------
       Firebase Auth Setup
    ----------------------------- */
    const provider = new firebase.auth.GoogleAuthProvider();
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const userNameEl = document.getElementById('userName');
    const userAvatarEl = document.getElementById('userAvatar');
    signInBtn.onclick = () => { auth.signInWithPopup(provider).catch(err => console.error('SignIn failed:', err)); };
    signOutBtn.onclick = () => { auth.signOut().catch(err => console.error('SignOut failed:', err)); };
    auth.onAuthStateChanged(user => {
      if (user) {
        userNameEl.textContent = user.displayName || 'User';
        userAvatarEl.src = user.photoURL || 'https://via.placeholder.com/40';
        signInBtn.style.display = 'none';
        signOutBtn.style.display = 'inline-block';
        db.ref('users/' + user.uid + '/profile').set({ name: user.displayName, email: user.email });
      } else {
        userNameEl.textContent = 'Guest';
        userAvatarEl.src = 'https://via.placeholder.com/40';
        signInBtn.style.display = 'inline-block';
        signOutBtn.style.display = 'none';
        document.getElementById('adminArea').style.display = 'none';
      }
    });

    /* ----------------------------
       MAIN PRACTICE TEST LOGIC
    ----------------------------- */
    let currentPractice, currentQuestions, timerInterval;
    let currentQuestionIndex = 0, correctAnswers = 0, timeRemaining = 600;
    const totalQuestions = 5;
    document.querySelectorAll('.start-practice').forEach(btn => { btn.addEventListener('click', () => startPractice(btn.dataset.type)); });
    document.getElementById('backToHomeFromPractice').onclick = () => { navigateTo('homePage'); };
    document.getElementById('nextButton').addEventListener('click', showQuestion);
    document.getElementById('toggleCalculator').addEventListener('click', toggleCalculator);
    
    function startPractice(type) {
      currentPractice = type;
      navigateTo('practicePage');
      document.getElementById('practiceTitle').textContent = `${type} Practice`;
      currentQuestions = shuffleArray(getQuestionsByType(type)).slice(0, totalQuestions);
      currentQuestionIndex = correctAnswers = 0;
      timeRemaining = 600;
      updateProgressBar();
      startTimer();
      showQuestion();
      document.getElementById('toggleCalculator').style.display = (type === 'Math') ? 'block' : 'none';
    }
    
    function getQuestionsByType(type) {
      return { Math: mathQuestions, Verbal: verbalQuestions, Writing: writingQuestions }[type] || [];
    }
    
    function shuffleArray(array) { return array.sort(() => Math.random() - 0.5); }
    
    function showQuestion() {
      if (currentQuestionIndex >= totalQuestions) { finishPractice(); return; }
      const question = currentQuestions[currentQuestionIndex];
      document.getElementById('questionLabel').textContent = question.text;
      document.getElementById('optionButtons').innerHTML = '';
      document.getElementById('feedbackLabel').textContent = '';
      document.getElementById('nextButton').style.display = 'none';
      // Remove previous passage and question number elements
      document.querySelectorAll('.passage-container, .question-number').forEach(el => el.remove());
      if (question.hasPassage) {
        const passageEl = document.createElement('div');
        passageEl.className = 'passage-container';
        passageEl.textContent = question.passage;
        document.getElementById('practiceView').insertBefore(passageEl, document.getElementById('questionLabel'));
      }
      const questionNumberEl = document.createElement('div');
      questionNumberEl.className = 'question-number';
      questionNumberEl.textContent = `Question ${currentQuestionIndex + 1} of ${totalQuestions}`;
      document.getElementById('practiceView').insertBefore(questionNumberEl, document.getElementById('questionLabel'));
      question.options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.textContent = `${String.fromCharCode(65 + idx)}. ${opt}`;
        btn.addEventListener('click', () => checkAnswer(opt));
        document.getElementById('optionButtons').appendChild(btn);
      });
      updateProgressBar();
    }
    
    function checkAnswer(answer) {
      const question = currentQuestions[currentQuestionIndex];
      const isCorrect = answer === question.correctAnswer;
      document.getElementById('feedbackLabel').textContent = isCorrect ? "Correct!" : `Incorrect. The correct answer is: ${question.correctAnswer}`;
      document.getElementById('feedbackLabel').style.color = isCorrect ? '#4CAF50' : '#F44336';
      if (isCorrect) correctAnswers++;
      currentQuestionIndex++;
      document.getElementById('nextButton').style.display = 'block';
      document.querySelectorAll('#optionButtons button').forEach(btn => btn.disabled = true);
      updateProgressBar();
    }
    
    function updateProgressBar() {
      document.getElementById('progressBar').style.width = `${(currentQuestionIndex / totalQuestions) * 100}%`;
    }
    
    function startTimer() {
      clearInterval(timerInterval);
      updateTimerDisplay();
      timerInterval = setInterval(() => {
        if (timeRemaining > 0) { timeRemaining--; updateTimerDisplay(); }
        else { clearInterval(timerInterval); finishPractice(); }
      }, 1000);
    }
    
    function updateTimerDisplay() {
      const minutes = Math.floor(timeRemaining / 60);
      const seconds = timeRemaining % 60;
      document.getElementById('timeRemaining').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    function finishPractice() {
      clearInterval(timerInterval);
      const scorePercentage = ((correctAnswers / totalQuestions) * 100).toFixed(1);
      const questionIDs = currentQuestions.map(q => q.id);
      const user = auth.currentUser;
      if (user) {
        const testData = {
          type: currentPractice,
          score: scorePercentage,
          correctAnswers,
          totalQuestions,
          date: new Date().toISOString(),
          questionIDs: questionIDs
        };
        window.satPracticeStorage.saveCompletedTest(testData);
        alert(`Practice complete! Your score: ${scorePercentage}%. Test saved to your account.`);
      } else {
        alert(`Practice complete! Your score: ${scorePercentage}%. (Sign in to save your results)`);
      }
      navigateTo('homePage');
    }
    
    function toggleCalculator() {
      const calculator = document.getElementById('dosCalculator');
      calculator.style.display = (calculator.style.display === 'none' ? 'block' : 'none');
    }
    
    /* ----------------------------
       TESTS PAGE & TABS FUNCTIONALITY
    ----------------------------- */
    const activeTab = document.getElementById('activeTab');
    const pastTab = document.getElementById('pastTab');
    activeTab.onclick = () => { setActiveTab(activeTab); loadUpcomingTests(); };
    pastTab.onclick = () => { setActiveTab(pastTab); loadPastTests(); };
    function setActiveTab(tab) {
      activeTab.classList.remove('active');
      pastTab.classList.remove('active');
      tab.classList.add('active');
    }
    
    function loadUpcomingTests() {
      const testsList = document.getElementById('testsList');
      testsList.innerHTML = "";
      const header = document.createElement("h3");
      header.textContent = "Upcoming Tests";
      testsList.appendChild(header);
      const ul = document.createElement("ul");
      testsList.appendChild(ul);
      if (window.satPracticeStorage.getAssignedTests) {
        window.satPracticeStorage.getAssignedTests(tests => {
          if (tests.length > 0) {
            tests.forEach(test => {
              const li = document.createElement("li");
              li.style.cursor = "pointer";
              li.textContent = `${test.type} Test scheduled for ${new Date(test.date).toLocaleString()}`;
              if (test.questionIDs) {
                const small = document.createElement("small");
                small.textContent = `Questions: ${test.questionIDs.join(', ')}`;
                li.appendChild(document.createElement("br"));
                li.appendChild(small);
              }
              li.addEventListener("click", () => { takeTest(test); });
              ul.appendChild(li);
            });
          } else { testsList.textContent = "No upcoming tests found."; }
        });
      } else { testsList.textContent = "Upcoming tests functionality is not available."; }
    }
    
    function loadPastTests() {
      const testsList = document.getElementById('testsList');
      testsList.innerHTML = "Loading past tests...";
      window.satPracticeStorage.getCompletedTests(tests => {
        if (tests.length > 0) {
          let html = "<h3>Past Tests</h3><ul>";
          tests.forEach(test => {
            html += `<li>${test.type} Test on ${new Date(test.date).toLocaleString()} - Score: ${test.score}%`;
            if (test.questionIDs) {
              html += `<br><small>Questions: ${test.questionIDs.join(', ')}</small>`;
            }
            html += "</li>";
          });
          html += "</ul>";
          testsList.innerHTML = html;
        } else { testsList.innerHTML = "No past tests found."; }
      });
    }
    
    /* ----------------------------
       TEST-TAKING FROM ASSIGNED TEST
       (Allows a user to click on an upcoming test and take it)
    ----------------------------- */
    function takeTest(testData) {
      // Determine the appropriate question bank based on test type
      let bank;
      const type = testData.type.toLowerCase();
      if (type === "math") bank = mathQuestions;
      else if (type === "verbal") bank = verbalQuestions;
      else if (type === "writing") bank = writingQuestions;
      else { alert("Unknown test type."); return; }
      // Convert questionIDs to numbers and filter the bank
      const ids = testData.questionIDs.map(id => parseInt(id, 10));
      currentQuestions = bank.filter(q => ids.includes(q.id));
      if (currentQuestions.length === 0) { alert("No matching questions found for this test."); return; }
      currentPractice = testData.type;
      currentQuestionIndex = 0;
      correctAnswers = 0;
      timeRemaining = 600;
      navigateTo("practicePage");
      document.getElementById("practiceTitle").textContent = `${testData.type} Test`;
      updateProgressBar();
      startTimer();
      showQuestion();
    }
    
    /* ----------------------------
       ADMIN TEST CREATION PAGE
    ----------------------------- */
    document.getElementById('navCreate').onclick = (e) => {
      e.preventDefault();
      if (window.isAdmin) { navigateTo('createTestPage'); }
      else { alert("Admin privileges required to create tests."); }
    };
    document.getElementById('backToHomeFromCreate').onclick = () => { navigateTo('homePage'); };
    document.getElementById('testForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const type = document.getElementById('testType').value;
      const date = document.getElementById('testDate').value;
      const questionIDsStr = document.getElementById('questionIDs').value;
      const questionIDs = questionIDsStr.split(',').map(id => id.trim());
      if (!type || !date || questionIDs.length === 0) {
        document.getElementById('createTestOutput').innerText = "Please complete all fields.";
        return;
      }
      const user = auth.currentUser;
      if (!user) { alert("You must be signed in to create a test."); return; }
      const testData = { type: type, date: date, questionIDs: questionIDs };
      db.ref(`assignedTests/${user.uid}`).push(testData)
        .then(() => {
          document.getElementById('createTestOutput').innerText = "Test created successfully.";
          document.getElementById('testForm').reset();
        })
        .catch(err => {
          document.getElementById('createTestOutput').innerText = "Error creating test: " + err.message;
        });
    });
    
    /* ----------------------------
       SETTINGS MODAL
    ----------------------------- */
    const settingsMenu = document.getElementById('settingsMenu');
    const settingsOutput = document.getElementById('settingsOutput');
    document.getElementById('btnCloseSettings').onclick = () => { settingsMenu.style.display = 'none'; };
    document.getElementById('btnViewSession').onclick = () => {
      window.satPracticeStorage.loadPracticeSession(session => {
        settingsOutput.innerText = session ? JSON.stringify(session, null, 2) : 'No saved practice session found.';
      });
    };
    document.getElementById('btnClearSession').onclick = () => {
      window.satPracticeStorage.clearPracticeSession();
      settingsOutput.innerText = 'Practice session cleared.';
    };
    document.getElementById('btnViewTests').onclick = () => {
      window.satPracticeStorage.getCompletedTests(tests => {
        settingsOutput.innerText = tests.length ? JSON.stringify(tests, null, 2) : 'No completed tests found.';
      });
    };
    document.getElementById('btnClearTests').onclick = () => {
      const user = auth.currentUser;
      if (!user) { settingsOutput.innerText = 'Not signed in. No tests to clear.'; return; }
      firebase.database().ref(`users/${user.uid}/completedTests`).remove()
        .then(() => { settingsOutput.innerText = 'Completed tests cleared.'; });
    };
    
    /* ----------------------------
       ADMIN FUNCTIONALITY
    ----------------------------- */
    document.getElementById('btnAdminLogin').onclick = () => {
      if (!auth.currentUser) { alert("You must be signed in to become an admin."); return; }
      const code = prompt("Enter the 4-digit admin code:");
      if (code === "1234") {
        window.isAdmin = true;
        alert("Admin privileges granted.");
        document.getElementById('adminArea').style.display = 'block';
        fetchAdminData();
      } else { alert("Incorrect code."); }
    };
    document.getElementById('refreshAdminData').onclick = fetchAdminData;
    function fetchAdminData() {
      firebase.database().ref('users').once('value')
        .then(snapshot => {
          const data = snapshot.val();
          let html = '';
          if (data) {
            for (const uid in data) {
              const profile = data[uid].profile;
              const name = (profile && profile.name) ? profile.name : 'Unknown';
              html += `<div><strong>User:</strong> ${name} (${uid})<br>`;
              if (data[uid].completedTests) {
                html += `<ul>`;
                for (const testKey in data[uid].completedTests) {
                  const test = data[uid].completedTests[testKey];
                  html += `<li>${test.type} Test on ${new Date(test.date).toLocaleString()} - Score: ${test.score}%<br>
                           <small>Questions: ${test.questionIDs.join(', ')}</small></li>`;
                }
                html += `</ul>`;
              } else { html += `<p>No completed tests.</p>`; }
              html += `</div>`;
            }
          } else { html = '<p>No user data found.</p>'; }
          document.getElementById('adminContent').innerHTML = html;
        })
        .catch(err => { console.error("Error fetching admin data:", err); });
    
    /* ----------------------------
       On Load: Default to Home Page
    ----------------------------- */
    window.addEventListener('load', () => { navigateTo('homePage'); });
  </script>
</body>
</html>
